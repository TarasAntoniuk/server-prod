name: Deploy Infrastructure

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: "docker-compose.yml,nginx/,postgres/"
        target: "/srv/infrastructure"
        strip_components: 0
        rm: false
    
    - name: Set permissions and start services
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /srv/infrastructure
          
          # Set executable permission
          chmod +x postgres/init-db.sh
          
          # Check if .env exists
          if [ ! -f .env ]; then
            echo "‚ùå ERROR: .env file not found!"
            echo "Please create .env on server manually"
            exit 1
          fi
          
          # Pull latest images
          docker-compose pull
          
          # Start services
          docker-compose up -d
          
          # Wait for services to stabilize
          echo "‚è≥ Waiting for services to start..."
          sleep 15

    - name: Verify deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /srv/infrastructure
          
          echo "========================================"
          echo "üîç Infrastructure Health Check"
          echo "========================================"
          echo ""
          
          # Check all containers are running
          echo "üì¶ Container Status:"
          docker-compose ps
          echo ""
          
          # Count running containers
          RUNNING=$(docker-compose ps | grep "Up" | wc -l)
          EXPECTED=3
          
          if [ $RUNNING -ne $EXPECTED ]; then
            echo "‚ùå Expected $EXPECTED containers running, but found $RUNNING"
            exit 1
          fi
          echo "‚úÖ All $RUNNING containers are running"
          echo ""
          
          # Test PostgreSQL
          echo "üóÑÔ∏è  PostgreSQL Health:"
          if docker exec shared-postgres pg_isready -U postgres > /dev/null 2>&1; then
            echo "‚úÖ PostgreSQL is ready"
            
            # Check databases exist
            echo ""
            echo "üìä Databases:"
            docker exec shared-postgres psql -U postgres -c "\l" | grep -E "finance|time_tracking" || echo "‚ö†Ô∏è  Warning: Expected databases not found"
          else
            echo "‚ùå PostgreSQL is not ready"
            exit 1
          fi
          echo ""
          
          # Test Nginx configuration
          echo "üåê Nginx Health:"
          if docker exec shared-nginx nginx -t > /dev/null 2>&1; then
            echo "‚úÖ Nginx configuration is valid"
          else
            echo "‚ùå Nginx configuration has errors"
            docker exec shared-nginx nginx -t
            exit 1
          fi
          echo ""
          
          # Check Nginx is responding
          echo "üîå Nginx Response:"
          if docker exec shared-nginx wget --spider --quiet http://localhost:80 2>&1; then
            echo "‚úÖ Nginx is responding on port 80"
          else
            echo "‚ö†Ô∏è  Nginx not responding on port 80 (might be expected during migration)"
          fi
          echo ""
          
          # Check Docker network
          echo "üåê Docker Network:"
          if docker network inspect app-network > /dev/null 2>&1; then
            echo "‚úÖ app-network exists"
            CONNECTED=$(docker network inspect app-network --format '{{len .Containers}}')
            echo "   Connected containers: $CONNECTED"
          else
            echo "‚ùå app-network does not exist"
            exit 1
          fi
          echo ""
          
          # Check volumes
          echo "üíæ Docker Volumes:"
          if docker volume inspect shared-postgres-data > /dev/null 2>&1; then
            echo "‚úÖ shared-postgres-data volume exists"
          else
            echo "‚ùå shared-postgres-data volume does not exist"
            exit 1
          fi
          echo ""
          
          # Check SSL certificates (if they should exist)
          echo "üîí SSL Certificates:"
          if [ -d "/srv/infrastructure/certs/live" ]; then
            echo "‚úÖ SSL certificates directory exists"
            ls -la /srv/infrastructure/certs/live/ || true
          else
            echo "‚ö†Ô∏è  SSL certificates not found (might be first deployment)"
          fi
          echo ""
          
          # Summary
          echo "========================================"
          echo "‚úÖ Deployment verification completed"
          echo "========================================"
          echo ""
          echo "üìä Resource Usage:"
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"
          echo ""
          echo "üéâ Infrastructure is healthy!"

    - name: Cleanup on failure
      if: failure()
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /srv/infrastructure
          echo "‚ùå Deployment failed. Showing logs..."
          echo ""
          echo "=== Docker Compose Logs ==="
          docker-compose logs --tail=50
          echo ""
          echo "=== Container Status ==="
          docker-compose ps -a
