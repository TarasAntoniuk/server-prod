name: Test SSH Connection

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-ssh:
    name: Test SSH and Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Test SSH connection and secrets
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "========================================"
            echo "üîê SSH Connection Test"
            echo "========================================"
            echo ""
            
            echo "‚úÖ SSH connection successful!"
            echo ""
            
            echo "üìä Server Information:"
            echo "  Hostname: $(hostname)"
            echo "  User: $(whoami)"
            echo "  OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d '"' -f 2)"
            echo "  Uptime: $(uptime -p)"
            echo "  Date: $(date)"
            echo ""
            
            echo "üê≥ Docker Information:"
            if command -v docker &> /dev/null; then
              echo "  Docker version: $(docker --version)"
              echo "  Docker Compose version: $(docker-compose --version)"
              echo "  Running containers: $(docker ps --format '{{.Names}}' | wc -l)"
            else
              echo "  ‚ùå Docker not found"
            fi
            echo ""
            
            echo "üìÅ Directory Check:"
            echo "  Home: $HOME"
            echo "  Current: $(pwd)"
            echo ""
            
            if [ -d "/srv/infrastructure" ]; then
              echo "  ‚úÖ /srv/infrastructure exists"
              echo "  Contents:"
              ls -lah /srv/infrastructure
              echo ""
              if [ -f "/srv/infrastructure/.env" ]; then
                echo "  ‚úÖ .env file exists"
              else
                echo "  ‚ö†Ô∏è  .env file NOT found"
              fi
            else
              echo "  ‚ö†Ô∏è  /srv/infrastructure does NOT exist (will be created during deployment)"
            fi
            echo ""
            
            echo "üåê Network Check:"
            echo "  Public IP: $(curl -s ifconfig.me || echo 'Unable to detect')"
            echo ""
            
            echo "========================================"
            echo "‚úÖ All checks completed successfully!"
            echo "========================================"